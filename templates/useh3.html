{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>Welcome, {{ username }}!</h2>
                <p class="lead">Book your temple visit slot</p>
            </div>
            <div class="text-end">
                <span class="badge bg-primary p-2">Current Time: <span id="current-time"></span></span>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-users"></i> Crowd Prediction for Today</h5>
            </div>
            <div class="card-body">
                <h3 class="text-center">{{ prediction }} people</h3>
                <div class="progress mt-3">
                    {% if prediction < 10000 %}
                    <div class="progress-bar bg-success" style="width: 30%">Low Crowd</div>
                    {% elif prediction < 30000 %}
                    <div class="progress-bar bg-warning" style="width: 60%">Moderate Crowd</div>
                    {% else %}
                    <div class="progress-bar bg-danger" style="width: 90%">High Crowd</div>
                    {% endif %}
                </div>
                <p class="mt-3 text-center">
                    {% if prediction < 10000 %}
                    <span class="badge bg-success">Good time to visit</span>
                    {% elif prediction < 30000 %}
                    <span class="badge bg-warning">Moderate crowding expected</span>
                    {% else %}
                    <span class="badge bg-danger">High crowding expected - consider another day</span>
                    {% endif %}
                </p>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-clock"></i> Time Slot Categories</h5>
            </div>
            <div class="card-body">
                <div class="time-category mb-3">
                    <h6 class="text-primary"><i class="fas fa-sun"></i> Morning (6:00 AM - 12:00 PM)</h6>
                    <small class="text-muted">Best for peaceful darshan</small>
                </div>
                <div class="time-category mb-3">
                    <h6 class="text-warning"><i class="fas fa-cloud-sun"></i> Afternoon (12:00 PM - 4:00 PM)</h6>
                    <small class="text-muted">Moderate crowd, good lighting</small>
                </div>
                <div class="time-category">
                    <h6 class="text-info"><i class="fas fa-moon"></i> Evening (4:00 PM - 8:00 PM)</h6>
                    <small class="text-muted">Aarti timing, spiritual atmosphere</small>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-bolt"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="#available-slots" class="btn btn-outline-primary">
                        <i class="fas fa-calendar-check"></i> View Available Slots
                    </a>
                    <a href="{{ url_for('visualization') }}" class="btn btn-outline-info">
                        <i class="fas fa-chart-line"></i> View Crowd Trends
                    </a>
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 id="available-slots"><i class="fas fa-ticket-alt"></i> Available Time Slots for Today at {{ temple_name }}</h5>
            </div>
            <div class="card-body">
                <!-- Morning Slots -->
                <h6 class="text-primary mb-3"><i class="fas fa-sun"></i> Morning Slots (6:00 AM - 12:00 PM)</h6>
                <div class="row mb-4">
                    {% for slot in slots if '08:00' in slot[1] or '09:00' in slot[1] or '10:00' in slot[1] or '11:00' in slot[1] %}
                    <div class="col-md-6 mb-3">
                        <div class="card slot-card morning-slot">
                            <div class="card-body">
                                <h5 class="card-title text-primary">{{ slot[1] }}</h5>
                                <p class="card-text">
                                    <span class="badge bg-success">{{ slot[2] }} slots available</span>
                                </p>
                                <p class="small text-muted">Duration: 1 hour</p>
                                <p class="price">₹50 per person</p>
                                <button class="btn btn-primary book-slot" data-slot-id="{{ slot[0] }}" data-slot-time="{{ slot[1] }}">
                                    <i class="fas fa-ticket-alt"></i> Book This Slot
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Afternoon Slots -->
                <h6 class="text-warning mb-3"><i class="fas fa-cloud-sun"></i> Afternoon Slots (12:00 PM - 4:00 PM)</h6>
                <div class="row mb-4">
                    {% for slot in slots if '12:00' in slot[1] or '13:00' in slot[1] or '14:00' in slot[1] or '15:00' in slot[1] %}
                    <div class="col-md-6 mb-3">
                        <div class="card slot-card afternoon-slot">
                            <div class="card-body">
                                <h5 class="card-title text-warning">{{ slot[1] }}</h5>
                                <p class="card-text">
                                    <span class="badge bg-success">{{ slot[2] }} slots available</span>
                                </p>
                                <p class="small text-muted">Duration: 1 hour</p>
                                <p class="price">₹50 per person</p>
                                <button class="btn btn-warning book-slot" data-slot-id="{{ slot[0] }}" data-slot-time="{{ slot[1] }}">
                                    <i class="fas fa-ticket-alt"></i> Book This Slot
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Evening Slots -->
                <h6 class="text-info mb-3"><i class="fas fa-moon"></i> Evening Slots (4:00 PM - 8:00 PM)</h6>
                <div class="row">
                    {% for slot in slots if '16:00' in slot[1] or '17:00' in slot[1] or '18:00' in slot[1] %}
                    <div class="col-md-6 mb-3">
                        <div class="card slot-card evening-slot">
                            <div class="card-body">
                                <h5 class="card-title text-info">{{ slot[1] }}</h5>
                                <p class="card-text">
                                    <span class="badge bg-success">{{ slot[2] }} slots available</span>
                                </p>
                                <p class="small text-muted">Duration: 1 hour</p>
                                <p class="price">₹50 per person</p>
                                <button class="btn btn-info text-white book-slot" data-slot-id="{{ slot[0] }}" data-slot-time="{{ slot[1] }}">
                                    <i class="fas fa-ticket-alt"></i> Book This Slot
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if not slots %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> No available slots for today. Please try another day.
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Booking Modal -->
        <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Book Your Slot</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="booking-step-1">
                            <h6>Selected Time Slot: <span id="selected-slot-time" class="text-primary"></span></h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Number of Persons</label>
                                        <select class="form-select" id="persons-count">
                                            <option value="1">1 Person</option>
                                            <option value="2">2 Persons</option>
                                            <option value="3">3 Persons</option>
                                            <option value="4">4 Persons</option>
                                            <option value="5">5 Persons</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Total Amount</label>
                                        <div class="input-group">
                                            <span class="input-group-text">₹</span>
                                            <input type="text" class="form-control" id="total-amount" value="50" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="full-name" required>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone-number" required>
                            </div>
                            <div class="form-group mb-3">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="email-address" required>
                            </div>
                        </div>
                        
                        <div id="booking-step-2" class="d-none">
                            <h6 class="text-success">Payment Details</h6>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Secure payment processing
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Card Number</label>
                                        <input type="text" class="form-control" placeholder="1234 5678 9012 3456" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Card Holder Name</label>
                                        <input type="text" class="form-control" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Expiry Date</label>
                                        <input type="text" class="form-control" placeholder="MM/YY" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">CVV</label>
                                        <input type="text" class="form-control" placeholder="123" required>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Amount</label>
                                        <div class="input-group">
                                            <span class="input-group-text">₹</span>
                                            <input type="text" class="form-control" id="payment-amount" readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-outline-primary" id="prev-step" style="display: none;">Previous</button>
                        <button type="button" class="btn btn-primary" id="next-step">Next</button>
                        <button type="button" class="btn btn-success" id="confirm-payment" style="display: none;">Confirm Payment</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ticket Display -->
        <div class="card mt-4 d-none" id="ticket-display">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-ticket-alt"></i> Your Booking Confirmation</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="ticket-info">
                            <h4 class="text-success">Booking Successful!</h4>
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <p><strong>Booking ID:</strong> <span id="ticket-booking-id"></span></p>
                                    <p><strong>Time Slot:</strong> <span id="ticket-slot-time"></span></p>
                                    <p><strong>Temple:</strong> {{ temple_name }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Date:</strong> <span id="ticket-date"></span></p>
                                    <p><strong>Persons:</strong> <span id="ticket-persons"></span></p>
                                    <p><strong>Amount Paid:</strong> ₹<span id="ticket-amount"></span></p>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-info-circle"></i> Please show this QR code at the temple entrance. 
                                Each slot is 1 hour duration for a decent temple experience.
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="qr-code">
                            <img id="ticket-qr-code" src="" alt="QR Code" class="img-fluid">
                        </div>
                        <button class="btn btn-outline-primary mt-3" onclick="window.print()">
                            <i class="fas fa-print"></i> Print Ticket
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
$(document).ready(function() {
    // Update current time
    function updateCurrentTime() {
        const now = new Date();
        $('#current-time').text(now.toLocaleTimeString());
    }
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);

    let currentSlotId = null;
    let currentSlotTime = null;

    $('.book-slot').click(function() {
        currentSlotId = $(this).data('slot-id');
        currentSlotTime = $(this).data('slot-time');
        $('#selected-slot-time').text(currentSlotTime);
        $('#bookingModal').modal('show');
        $('#booking-step-1').removeClass('d-none');
        $('#booking-step-2').addClass('d-none');
        $('#prev-step').hide();
        $('#next-step').show();
        $('#confirm-payment').hide();
    });

    $('#persons-count').change(function() {
        const persons = parseInt($(this).val());
        const amount = persons * 50;
        $('#total-amount').val(amount);
        $('#payment-amount').val(amount);
    });

    $('#next-step').click(function() {
        $('#booking-step-1').addClass('d-none');
        $('#booking-step-2').removeClass('d-none');
        $('#prev-step').show();
        $('#next-step').hide();
        $('#confirm-payment').show();
    });

    $('#prev-step').click(function() {
        $('#booking-step-2').addClass('d-none');
        $('#booking-step-1').removeClass('d-none');
        $('#prev-step').hide();
        $('#next-step').show();
        $('#confirm-payment').hide();
    });

    // ✅ Confirm payment and open Razorpay checkout
    $('#confirm-payment').click(function() {
        const persons = $('#persons-count').val();
        const amount = persons * 50;
        const fullName = $('#full-name').val();
        const phone = $('#phone-number').val();
        const email = $('#email-address').val();

        if (!fullName || !phone || !email) {
            alert('Please fill all required fields');
            return;
        }

        $('#confirm-payment').html('<i class="fas fa-spinner fa-spin"></i> Processing...').prop('disabled', true);

        // 1️⃣ Create order on backend
        $.ajax({
            url: "/create_order",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify({
                slot_id: currentSlotId,
                persons: persons,
                amount: amount
            }),
            success: function(order) {
                // 2️⃣ Open Razorpay checkout
                var options = {
                    "key": "{{ razorpay_key }}",  // passed from Flask
                    "amount": order.amount,
                    "currency": "INR",
                    "name": "Temple Darshan Booking",
                    "description": "Slot booking payment",
                    "order_id": order.id,
                    "handler": function (response){
                        // 3️⃣ Verify payment on backend
                        $.ajax({
                            url: "/verify_payment",
                            type: "POST",
                            contentType: "application/json",
                            data: JSON.stringify({
                                payment_id: response.razorpay_payment_id,
                                order_id: response.razorpay_order_id,
                                signature: response.razorpay_signature,
                                booking_id: order.notes.booking_id
                            }),
                            success: function(result) {
                                if(result.success){
                                    $('#bookingModal').modal('hide');
                                    $('#ticket-booking-id').text(result.booking_id);
                                    $('#ticket-slot-time').text(currentSlotTime);
                                    $('#ticket-date').text(new Date().toLocaleDateString());
                                    $('#ticket-persons').text(persons);
                                    $('#ticket-amount').text(amount);
                                    $('#ticket-qr-code').attr('src', 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + result.qr_code);
                                    $('#ticket-display').removeClass('d-none');
                                    $('html, body').animate({ scrollTop: $('#ticket-display').offset().top }, 1000);
                                } else {
                                    alert("Payment verification failed");
                                }
                                $('#confirm-payment').html('Confirm Payment').prop('disabled', false);
                            }
                        });
                    },
                    "prefill": {
                        "name": fullName,
                        "email": email,
                        "contact": phone
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };
                var rzp1 = new Razorpay(options);
                rzp1.open();
            }
        });
    });

    $('#bookingModal').on('hidden.bs.modal', function() {
        $('#persons-count').val('1');
        $('#total-amount').val('50');
        $('#payment-amount').val('50');
        $('#full-name').val('');
        $('#phone-number').val('');
        $('#email-address').val('');
        $('#confirm-payment').html('Confirm Payment').prop('disabled', false);
    });
});
</script>